---
chapter_no: 40
chapter_title: ケース４ SQLインジェクション攻撃によるパスワード変更 〜シングルクォート挿入〜
created: 2008-04-12
updated: 2021-04-01
---
さて、今度はデータを変更するパターンの攻撃についてご紹介しましょう。

### 攻撃手法
利用するテーブルは[ケース１](#ケース１ SQLインジェクション攻撃による不正ログイン 〜シングルクォート挿入〜)と同じものとして、ユーザIDと現在のパスワードおよび新しいパスワードを受け取り、データベースの更新が行われる例で考えてみましょう。

<div class="code-box">
<div class="title">SQL</div>
<pre>
UPDATE ユーザマスタ SET パスワード = '${newPasswd}' WHERE ユーザID = '${userId}' AND パスワード = '${oldPasswd}'
</pre>
</div>

ユーザによって入力されたユーザID、旧パスワード、新パスワードをそれぞれ`${userId}`、`${oldPasswd}`、`${newPasswd}`に代入し、上記SQLにてその存在が確認し、合致すればパスワードの変更が完了します。  
悪意あるユーザ「`rose`」が、自身のパスワード「`fuga`」とユーザ「`admin`」のパスワードを「`malice`」に書き換えを試みる際に入力するパラメータは、以下のようになります。

<dl>
  <dt>$userId</dt>
  <dd>rose</dd>
  <dt>$oldPasswd</dt>
  <dd>fuga' OR ユーザID = 'admin</dd>
  <dt>$newPasswd</dt>
  <dd>malice</dd>
</dl>

結果、生成されるSQL文は以下のようなものになります。

<div class="code-box">
<div class="title">SQL</div>
<pre>
UPDATE ユーザマスタ SET パスワード = 'malice' WHERE ユーザID = 'rose' AND パスワード = 'fuga' <em>OR ユーザID = 'admin'</em>
</pre>
</div>

ユーザIDが「`rose`」でパスワードが「`fuga`」であるレコード、またはユーザIDが「`admin`」であるレコードを更新対象としてしまいます。  
つまり、「`admin`」のパスワードが分からなくても「`admin`」のパスワードを変更することが可能となるわけです。  
更新後のテーブルの様子は以下のようになります。

<table class="normal">
    <caption>テーブル名：ユーザマスタ(更新後)</caption>
    <tr><th>ユーザID</th><th>パスワード</th></tr>
    <tr><td>admin</td><td><strong>malice</strong></td></tr>
    <tr><td>fumo</td><td>hoge</td></tr>
    <tr><td>cynthia</td><td>piyo</td></tr>
    <tr><td>rose</td><td><strong>malice</strong></td></tr>
</table>
