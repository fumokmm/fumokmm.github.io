---
chapter_no: 60
chapter_title: ケース１〜５の回避方法・対策
created: 2008-04-12
updated: 2021-04-01
---
今まで見てきたSQLインジェクションの攻撃に対する回避方法・対策についてご紹介しましょう。

### 特殊文字のエスケープ(サニタイジング)
SQL文に含まれたパラメータに対して、危険な文字列を検出し特殊文字として認識させないように適切に置換・除去を行うエスケープ処理(サニタイジング)で対応します。  
エスケープ対象は処理系によって異なりますが、一般的には次の通りです。

<table class="normal">
	<tr>
		<th markdown="span">特殊文字</th>
		<th markdown="span">エスケープ処理</th>
	</tr>
	<tr>
		<td><span class="code-font">'</span></td>
		<td><span class="code-font">''</span></td>
	</tr>
	<tr>
		<td><span class="code-font">;</span></td>
		<td markdown="span">受理しない</td>
	</tr>
	<tr>
		<td markdown="span">その他の特殊文字</td>
		<td markdown="span">エスケープ文字(\\)を前に付加する</td>
	</tr>
</table>

「`'`」→「`''`」とシングルクォートを二つ重ねてエスケープすることで、文字列を囲むシングルクォートでなはく、シングルクォート文字列定数として扱うようにします。

このようにSQLインジェクションは特殊文字を悪用することによって行われるため、入力チェックとサニタイジングが有効です。  
ただしデータベースエンジンはそれごとにSQLが独自拡張されていることがありますので、サニタイジングが必要な特殊文字が変わってくることがあります。  
データベースエンジンごとに機能を持つ特殊文字をリストアップし、正しくエスケープ処理を実装する必要があります。

### SQL文の組み立てにバインド機構を使用する(準備済みSQLの利用)
あらかじめコンパイルしたSQL文をデータベース側に持たせておき、値だけをデータベースに渡して実行させるためのDBMSの機能があります。  
具体的にはプレースホルダと呼ばれる一般的な特殊文字(「`?`」など)を使用してSQL文の雛形を用意しておき、後で実際の値(変数)を割り当ててSQL文を完成させます。  
バインドメカニズム(バインド機構)、準備済みSQL文、プリペアードステートメント、パラメータクエリ[^parameter-query]、ストアドプロシージャとも呼ばれます。  

[^parameter-query]: クエリの一部が変数のようになっており、その部分は実行時にバインドするクエリ。

これにより、入力データは数値定数や文字列定数として組み込まれるため、シングルクォートなどの特殊文字はエスケープ処理せずとも強制的にただのパラメータ文字として認識され、SQL文の意味も改変される危険性がなくなります。  
また、入力前にコンパイルされているので、SQLインジェクションによってSQL文を変更することが不可能になります。  
特殊文字のエスケープよりも有効な手法であり、<b>SQLインジェクション対策の最も有効的な方法</b>です。
