---
title: SQLインジェクションのまとめ
display_order: 10
created: 2008-04-12
updated: 2020-11-05
---
こちらはSQLインジェクションについてまとめたものになります。

## 目次

- [ケース１ SQLインジェクション攻撃による不正ログイン 〜シングルクォート挿入〜](#case1)
- [ケース２ SQLインジェクション攻撃による任意のSQL文実行 〜セミコロンで分割〜](#case2)
- [ケース３ SQLインジェクション攻撃による任意のSQL文実行 〜コメントアウトで無効化〜](#case3)
- [ケース４ SQLインジェクション攻撃によるパスワード変更 〜シングルクォート挿入〜](#case4)
- [ケース５ SQLインジェクション攻撃によるパスワード変更 〜コメントアウトで無効化〜](#case5)
- [ケース１〜５の回避方法・対策](#workaround-methods-and-countermeasures-for-case1to5)
- [ケース６ セカンドオーダSQLインジェクション](#case6)
- [ケース６の回避方法・対策](#workaround-methods-and-countermeasures-for-case6)

## <a name="case1">ケース１ SQLインジェクション攻撃による不正ログイン 〜シングルクォート挿入〜</a>
まずは、SQLインジェクションの最も基本的な攻撃パターンであるシングルクォート「`'`」を使った手法をご紹介します。

### 攻撃手法
以下のようなテーブルがあるとします。

<table>
    <tr><th>ユーザID</th><th>パスワード</th></tr>
    <tr><td>admin</td><td>admin</td></tr>
    <tr><td>fumo</td><td>hoge</td></tr>
    <tr><td>cynthia</td><td>piyo</td></tr>
    <tr><td>rose</td><td>fuga</td></tr>
</table>

<div class="code-box">
<div class="title">SQL</div>
<pre>
SELECT * FROM ユーザマスタ WHERE ユーザID = '$userId' AND パスワード = '$passwd'
</pre>
</div>

ユーザによって入力されたユーザID、パスワードをそれぞれ`$userId`、`$passwd`に代入し、上記SQLにてその存在が確認できればログインできるWEBページがあります。
悪意あるユーザがユーザID「`fumo`」としてパスワードを入力せずにログインを試みる際に入力するパラメータは、以下のようになります。

<dl>
  <dt>$userId</dt>
  <dd>fumo</dd>
  <dt>$passwd</dt>
  <dd>' OR 'A' = 'A</dd>
</dl>

結果、生成されるSQL文は以下のようなものになります。

<div class="code-box">
<div class="title">SQL</div>
<pre>
SELECT * FROM ユーザマスタ WHERE ユーザID = 'fumo' AND <em>パスワード = '' OR 'A' = 'A'</em>
</pre>
</div>

パラメータとして入力値「`'`」を含ませることで、パスワードに関するWHERE句の条件式を一旦終端させ、次にORを含ませると、「`'A' = 'A'`」という恒真式がORの対象になります。  
よって、WHERE句全体が常に真となり、パスワードを入力せずにユーザID「`fumo`」としてログインすることが可能となります。

ちなみに、「`'A' = 'A`」の部分は「`'1' = '1`」でも「`'' = '`」でも大丈夫です。OR以降が常に真となるような恒真式が記述されることが重要です。


## <a name="case2">ケース２ SQLインジェクション攻撃による任意のSQL文実行 〜セミコロンで分割〜</a>

さて次は、[ケース１](#case1)の応用例として任意のSQL文を実行させる手法を紹介します。  
ここではレコードの全件削除を例にとって説明します。

### 攻撃手法
SQL文におけるセミコロン「`;`」は、ステートメントを分割するデリミタです。この「`;`」を使って複数のSQL文を連結させることができます。  
利用するテーブルは[ケース１](#case1)と同じものとして、今回は以下のようにパラメータを入力してみます。

<dl>
  <dt>$userId</dt>
  <dd> (何も入力しない) </dd>
  <dt>$passwd</dt>
  <dd>'; DELETE FROM ユーザマスタ WHERE 'A' = 'A</dd>
</dl>

さて、どんなSQLが生成されるでしょうか。


<div class="code-box">
<div class="title">SQL</div>
<pre>
SELECT * FROM ユーザマスタ WHERE ユーザID = '' AND パスワード = ''<em>; DELETE FROM ユーザマスタ WHERE 'A' = 'A'</em>
</pre>
</div>

このようになります。  
これは以下のように二つのSQL文が続けて実行されることを意味します。

<div class="code-box">
<div class="title">SQL</div>
<pre>
SELECT * FROM ユーザマスタ WHERE ユーザID = '' AND パスワード = '';
DELETE FROM ユーザマスタ WHERE 'A' = 'A'
</pre>
</div>

一つ目のSELECT文は実行されますが無害です。  
このようにパラメータに「`;`」を含ませることで、WHERE句を一旦終端させ、全件削除のDELETE文をさせることができます。  
なお、「`'`」の数をあわせるために、ケース１と同様に「`'A' = 'A'`」という恒真式にして、DELETE文のWHERE句を無効化しています。

## <a name="case3">ケース３ SQLインジェクション攻撃による任意のSQL文実行 〜コメントアウトで無効化〜</a>
更に応用例として、コメントアウト「`--`」を使用してパスワード入力部分のSQLを無効化する手法を紹介します。


### 攻撃手法
利用するテーブルは[ケース１](#case1)と同じものとして、以下のようにパラメータを入力してみる。


:$userId:「'; DELETE FROM ユーザマスタ WHERE 'A' = 'A' --」
:$passwd:「 (何も入力しない) 」


これで、以下のようなSQL文が実行される。


>|sql|
SELECT * FROM ユーザマスタ WHERE ユーザID = '';
DELETE FROM ユーザマスタ WHERE 'A' = 'A' --' AND パスワード = ''
||<


「--」以下の「' AND パスワード = ''」の部分はコメントアウトされるので無効となり、結果としてケース２と同様に全件削除のSQL文として機能する。

## <a name="case4">ケース４ SQLインジェクション攻撃によるパスワード変更 〜シングルクォート挿入〜</a>
さて、今度はデータを変更するパターンの攻撃についてご紹介する。


### 攻撃手法
利用するテーブルは[ケース１](#case1)と同じものとして、ユーザIDと現在のパスワードおよび新しいパスワードを受け取り、データベースの更新が行われる例で考えてみる。


>|sql|
UPDATE ユーザマスタ SET パスワード = '{$newPasswd}' WHERE ユーザID = '{$userId}' AND パスワード = '{$oldPasswd}'
||<


ユーザによって入力されたユーザID、旧パスワード、新パスワードをそれぞれ{$userId}、{$oldPasswd}、{$newPasswd}に代入し、上記SQLにてその存在が確認し、合致すればパスワードの変更が完了する。
悪意あるユーザ「rose」が、自身のパスワード「fuga」とユーザ「admin」のパスワードを「malice」((悪意、敵意、害意という意味。))に書き換えを試みる際に入力するパラメータは、以下のようになる。


:$userId:「rose」
:$oldPasswd:「fuga' OR ユーザID = 'admin」
:$newPasswd:「malice」


結果、生成されるSQL文は以下のようなものになる。


>|sql|
UPDATE ユーザマスタ SET パスワード = 'malice' WHERE ユーザID = 'rose' AND パスワード = 'fuga' OR ユーザID = 'admin'
||<


ユーザIDが「rose」でパスワードが「fuga」であるレコード、またはユーザIDが「admin」であるレコードを更新対象としてしまう。
つまり、「admin」のパスワードが分からなくても「admin」のパスワードを変更することが可能となる。
更新後のテーブルの様子は以下のようになる


<div align="center">
[テーブル名：ユーザマスタ(更新後)]
|*ユーザID|*パスワード|
|admin|<strong>malice</strong>|
|fumo|hoge|
|cynthia|piyo|
|rose|<strong>malice</strong>|
</div>


## <a name="case5">ケース５ SQLインジェクション攻撃によるパスワード変更 〜コメントアウトで無効化〜</a>
さて、今度は[ケース４](#case4)の応用で全データを変更するパターンの攻撃についてご紹介する。


### 攻撃手法
利用するテーブル、条件は[ケース４](#case4)と同様とし、悪意あるユーザが全ユーザのパスワードを「malice」に書き換えを試みる際に入力するパラメータは、以下のようになる。


:$userId:「' OR 'A' = 'A' --」
:$oldPasswd:「 (何も入力しない) 」
:$newPasswd:「malice」


結果、生成されるSQL文は以下のようなものになる。


>|sql|
UPDATE ユーザマスタ SET パスワード = 'malice' WHERE ユーザID = '' OR 'A' = 'A' --' AND パスワード = ''
||<


[ケース３](#case3)と同様に「'A' = 'A'」の恒真式にしつつ、それ以降をコメントアウトしてWHERE句を無効化する。
結果、全員のパスワードが「malice」に変更されてしまう。
更新後のテーブルの様子は以下のようになる


<div align="center">
[テーブル名：ユーザマスタ(更新後)]
|*ユーザID|*パスワード|
|admin|<strong>malice</strong>|
|fumo|<strong>malice</strong>|
|cynthia|<strong>malice</strong>|
|rose|<strong>malice</strong>|
</div>


## <a name="workaround-methods-and-countermeasures-for-case1to5">ケース１〜５の回避方法・対策</a>
今まで見てきたSQLインジェクションの攻撃に対する回避方法・対策についてご紹介する。


***特殊文字のエスケープ(サニタイジング)
SQL文に含まれたパラメータに対し、危険な文字列を検出し、特殊文字として認識させないように適切に置換・除去を行うエスケープ処理(サニタイジング)で対応する。
エスケープ対象は処理系によって異なるが、一般的には次の通りである。


<div align="center">
|*特殊文字|*エスケープ処理|
|'|''|
|;|受理しない|
|その他の特殊文字|エスケープ文字(\)を前に付加する|
</div>


「'」→「''」とシングルクォートを二つ重ねてエスケープすることで、文字列を囲むシングルクォートでなはく、シングルクォートを文字列定数として扱うようにする。


このようにSQLインジェクションも特殊文字を悪用することによって行われるので、入力チェックとサニタイジングが有効である。
ただし、データベースエンジンごとにSQLが独自拡張されていて、サニタイジングが必要な特殊文字が変わってくる。データベースエンジンごとに機能を持つ特殊文字をリストアップし、正しくエスケープ処理を実装する必要がある。


***SQL文の組み立てにバインド機構を使用する(準備済みSQLの利用)
あらかじめコンパイルしたSQL文をデータベース側に持たせておき、値だけをデータベースに渡して実行させるためのDBMSの機能である。
具体的にはプレースホルダと呼ばれる一般的な特殊文字を使用してSQL文の雛形を用意しておき、後で実際の値(変数)を割り当ててSQL文を完成させる。
バインドメカニズム(バインド機構)、準備済みSQL文、プリペアードステートメント、パラメータクエリ(クエリの一部が変数のようになっており、その部分は実行時にバインドするクエリ)、ストアードプロシージャとも呼ばれる。


これにより、入力データは数値定数や文字列定数として組み込まれるため、シングルクォートなどの特殊文字は、エスケープ処理せずとも強制的にただのパラメータ文字として認識され、SQL文の意味も改変される危険性がなくなる。
また、入力前にコンパイルされているので、SQLインジェクションによってSQL文を変更することが不可能になる。
特殊文字のエスケープよりも有効な手法であり、SQLインジェクション対策の最も有効的な方法である。


## <a name="case6">ケース６ セカンドオーダSQLインジェクション</a>
最後に入力データに適切にサニタイジング処理を施している場合でも攻撃が可能となるセカンドオーダSQLインジェクションについてご紹介しよう。

### 攻撃手法
例によって[ケース１](#case1)と同じテーブルを利用し、「(1)ユーザ登録機能」 と「(2)パスワード変更機能」があるWebシステムを考える。
「(1)ユーザ登録機能」では「ユーザID」と「パスワード」を入力して新たにユーザを登録する。
「(2)パスワード変更機能」ではログイン後に、ログインしているユーザのパスワードを変更するもので、「旧パスワード」および「新パスワード」を入力してパスワードの変更を行う。


この、「パスワード変更機能」は以下のように二つのSQL文によって実行されるものとする。


>|sql|
SELECT * FROM ユーザマスタ WHERE ユーザID = '{$userId}' AND パスワード = '{$oldPasswd}'
UPDATE ユーザマスタ SET パスワード = '{$newPasswd}' WHERE ユーザID = '取得したユーザID'
||<


二つ目のUPDATE文で指定するユーザIDは一つ目のSQL文で取得したユーザIDを用いる。
なお、適切にサニタイジング処理が行われるものとする。


セカンドオーダSQLインジェクションは、このように一度挿入されたデータが再利用されるような機能を利用して、間接的に攻撃を行う手法である。
具体的には以下のようにパラメータを入力すればよい。


(1)ユーザ登録
ユーザID＝「admin' --」、パスワード＝「passwd」として新規登録する。
するとシングルクォートを正しくエスケープした以下のようなINSERT文によりユーザが登録される。

>|sql|
INSERT INTO ユーザマスタ VALUES ( 'admin'' --', 'passwd' )
||<

結果、ユーザID「admin' --」としてユーザ登録される。


<div align="center">
[テーブル名：ユーザマスタ（登録後）]
|*ユーザID|*パスワード|
|admin|admin|
|fumo|hoge|
|cynthia|piyo|
|rose|fuga|
|<strong>admin' --</strong>|<strong>passwd</strong>|
</div>


(2)パスワード更新
次に「admin' --」のパスワードを変更するために、例えば旧パスワード「passwd」を新パスワード「passwd2」を入力する。
この入力により、以下SELECT文となり、ユーザIDをを引き当てる。


>|sql|
SELECT * FROM ユーザマスタ WHERE ユーザID = 'admin'' --' AND パスワード = 'passwd'
||<


外部から受け取る値は新パスワードだけなので、新パスワードのみエスケープ処理される。
ユーザIDはエスケープされずにデータベースに格納された値「admin' --」がそのまま用いられる。


>|sql|
UPDATE ユーザマスタ SET パスワード = 'passwd2' WHERE ユーザID = 'admin' --''
||<


このSQL文の末尾の「--''」の部分は無視されるため、以下の「admin」のパスワードを「passwd2」に変更するSQL文が実行されることとなる。


>|sql|
UPDATE ユーザマスタ SET パスワード = 'passwd2' WHERE ユーザID = 'admin'
||<


悪意ある攻撃者はこの手法により、管理者「admin」のパスワードを自由に書き換えてしまうことが可能となる。


## <a name="workaround-methods-and-countermeasures-for-case6">ケース６の回避方法・対策</a>
***
一般のSQLインジェクション対策としては、バインド機構＋サニタイジングの組み合わせが採用されているが、セカンドオーダSQLインジェクションはこれらの対策を潜り抜けて実行される。
これは、SQLインジェクションを防ぐのに、外部から受け取るパラメータのみエスケープしているときに発生する。


この攻撃も踏まえた正しいSQLインジェクション対策としては、文字列連結でSQL文を構築しようとするすべての箇所でエスケープ処理を適切に行う必要がある。
データベースに格納済みの値ももれなく行う必要がある。


## 参考書籍

- {% include book/book_593.html %} {% comment %} テクニカルエンジニア 情報セキュリティ［午後］オリジナル問題集 2008年度版 {% endcomment %}

## 関連情報
{% include update_info.html created="2009-01-24" updated="2020-10-24" %}

- [(Wikipedia) SQLインジェクション](http://ja.wikipedia.org/wiki/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3)
- [(@IT) 今夜分かるSQLインジェクション対策](https://www.atmarkit.co.jp/ait/articles/0611/02/news127.html)
